var VideoStream=require("./video-stream"),VideoManager=function(g){var e={},f=[],h=function(a,b){void 0===e[a]&&(e[a]=[]);e[a][b]=!0},k=function(a,b){var c=l(a);if(null==c){var d=f.length;c=new VideoStream(a,function(a){for(var b in g.sockets.adapter.rooms)void 0!==e[b]&&void 0!==e[b][d]&&g.sockets["in"](b).emit("h264",[d,a])});f[d]={rtspUrl:a,videoStream:c,rtspIndex:d};h(b,d);"all"!=b&&h("all",d);b!=d&&h(d,d)}else void 0!==e[b]&&(e[b][c.rtspIndex]=!0)},m=function(a,b){var c=l(a);if(null!=c){var d=
c.rtspIndex;void 0!==e[b]&&delete e[b][d];g.sockets["in"](b).emit("del rtsp",d);a:{for(var h in e)if(void 0!==e[h][c.rtspIndex])break a;console.log("stopMpeg1Stream rtspUrl="+a+" room="+b);c.videoStream.stopMpeg1Stream();delete f[c.rtspIndex]}}},l=function(a){for(var b in f){var c=f[b];if(c.rtspUrl==a)return c}return null};return{verifyStartupVideoStream:function(a,b){if("add all"==a)for(var c in rtsps){var d=rtsps[c].substring(4,rtsps[c].length);k(d,b)}else if("del all"==a)for(d in f)m(f[d].rtspUrl,
b);else if(a.startsWith("rtsp://")||a.startsWith("add rtsp://")||a.startsWith("del rtsp://"))a.startsWith("rtsp://")&&k(a,b),a.startsWith("add rtsp://")&&(c=a.substring(4,a.length),k(c,b)),a.startsWith("del rtsp://")&&(c=a.substring(4,a.length),m(c,b))},sendVideoStream:function(a,b){g.sockets["in"](a).emit("h264",[a,b]);g.sockets["in"]("all").emit("h264",[a,b])}}};module.exports=VideoManager;