var VideoStream=require("./video-stream"),VideoManager=function(g){var e={},f=[],h=function(a,c){void 0===e[a]&&(e[a]=[]);e[a][c]=!0},k=function(a,c){var b=l(a);if(null==b){var d=f.length;b=new VideoStream(a,function(a){for(var b in g.sockets.adapter.rooms)void 0!==e[b]&&void 0!==e[b][d]&&g.sockets["in"](b).emit("h264",[d,a])});f[d]={rtspUrl:a,videoStream:b,rtspIndex:d};h(c,d);"all"!=c&&h("all",d);c!=d&&h(d,d)}else void 0!==e[c]&&(e[c][b.rtspIndex]=!0)},m=function(a,c){var b=l(a);if(null!=b){var d=
b.rtspIndex;void 0!==e[c]&&delete e[c][d];g.sockets["in"](c).emit("del rtsp",d);a:{for(var h in e)if(void 0!==e[h][b.rtspIndex])break a;console.log("stopMpeg1Stream rtspUrl="+a+" room="+c);b.videoStream.stopMpeg1Stream();delete f[b.rtspIndex]}}},l=function(a){for(var c in f){var b=f[c];if(b.rtspUrl==a)return b}return null};return{verifyStartupVideoStream:function(a,c){if("add all"==a)for(var b in rtsps){var d=rtsps[b].substring(4,rtsps[b].length);k(d,c)}else if("del all"==a)for(d in f)m(f[d].rtspUrl,
c);else if(a.startsWith("rtsp://")||a.startsWith("add rtsp://")||a.startsWith("del rtsp://"))a.startsWith("rtsp://")&&k(a,c),a.startsWith("add rtsp://")&&(b=a.substring(4,a.length),k(b,c)),a.startsWith("del rtsp://")&&(b=a.substring(4,a.length),m(b,c))},sendVideoStream:function(a,c,b){g.sockets["in"](a).emit("h264",[a,c]);if(void 0!==b){Array.isArray(b)||(b=[b]);for(var d in b)g.sockets["in"](b[d].toString()).emit("h264",[a,c])}g.sockets["in"]("all").emit("h264",[a,c])}}};module.exports=VideoManager;